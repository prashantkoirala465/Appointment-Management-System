<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - Appointment System</title>

    <!-- Bootstrap CSS for responsive grid utilities only -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
    <!-- Custom design system -->
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
</head>
<body>

@if (User.Identity != null && User.Identity.IsAuthenticated)
{
    @* ========== AUTHENTICATED LAYOUT: Sidebar + Content ========== *@
    <div class="layout-app">
        <!-- Mobile top bar (visible only on small screens) -->
        <div class="mobile-header">
            <span class="brand-mobile">AppointmentSystem</span>
            <button class="menu-toggle" onclick="toggleSidebar()" aria-label="Toggle menu">&#9776;</button>
        </div>

        <!-- Sidebar overlay for mobile -->
        <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

        <!-- Sidebar navigation -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-brand">
                <a asp-controller="Dashboard" asp-action="Index">
                    AppointmentSystem
                    <span class="brand-sub">Management Platform</span>
                </a>
            </div>

            <ul class="sidebar-nav">
                <!-- Dashboard is always available -->
                <li>
                    <a href="@Url.Action("Index", "Dashboard")"
                       class="@(ViewContext.RouteData.Values["controller"]?.ToString() == "Dashboard" ? "active" : "")">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg>
                        Dashboard
                    </a>
                </li>

                <!-- Dynamic menus assigned to this user -->
                @if (ViewData["UserMenus"] is List<AppointmentSystem.Web.Models.Menu> userMenus && userMenus.Any())
                {
                    <li><span class="nav-section">Navigation</span></li>
                    @foreach (var menu in userMenus)
                    {
                        @* Determine active state by matching the menu URL to the current path *@
                        var isActive = Context.Request.Path.StartsWithSegments(menu.Url, StringComparison.OrdinalIgnoreCase);
                        <li>
                            <a href="@menu.Url" class="@(isActive ? "active" : "")">
                                @if (menu.MenuName == "Appointments")
                                {
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                                }
                                else if (menu.MenuName == "Staff")
                                {
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                                }
                                else
                                {
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
                                }
                                @menu.MenuName
                            </a>
                        </li>
                    }
                }
            </ul>

            <!-- Sidebar footer: user info + logout -->
            <div class="sidebar-footer">
                <div class="sidebar-user">
                    <div class="sidebar-avatar">
                        @(User.Identity.Name?.Substring(0, 1).ToUpper())
                    </div>
                    <div class="sidebar-user-info">
                        <div class="sidebar-user-name">@(User.Claims.FirstOrDefault(c => c.Type == "FullName")?.Value ?? User.Identity.Name)</div>
                        <div class="sidebar-user-role">@(User.IsInRole("Admin") ? "Administrator" : "Staff")</div>
                    </div>
                </div>
                <div class="sidebar-logout">
                    <form asp-controller="Account" asp-action="Logout" method="post">
                        <button type="submit">Sign Out</button>
                    </form>
                </div>
            </div>
        </aside>

        <!-- Main content area -->
        <div class="main-content">
            <div class="content-body">
                @RenderBody()
            </div>
        </div>
    </div>
}
else
{
    @* ========== PUBLIC LAYOUT: Full-bleed, no sidebar ========== *@
    <div class="layout-public">
        @RenderBody()
    </div>
}

    <!-- Bootstrap JS (for grid & mobile utilities) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
    <!-- jQuery + validation for forms -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery-validation@1.20.0/dist/jquery.validate.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery-validation-unobtrusive@4.0.0/dist/jquery.validate.unobtrusive.min.js" crossorigin="anonymous"></script>
    <script src="~/js/site.js" asp-append-version="true"></script>
    @await RenderSectionAsync("Scripts", required: false)
</body>
</html>
